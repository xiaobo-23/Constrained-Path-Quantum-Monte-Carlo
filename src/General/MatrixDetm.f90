!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! PROGRAM: Several subroutines used to calculate the matrix determinants for real and complex square matrices.
!          Need the LAPACK mathematical library.
!          Note: A real matrix must have real matrix determinant.
!
!          These subroutines calculate the determinant by the LU decomposition of square matrix.
!
! COMMENT: Common file.  
! AUTHOR:  Yuan-Yao He
! DATE:    2020-02-27
! PURPOSE: Different subroutines are introduced as following:
!
!    MatDetermtZ_Det    --> Subroutine to calculate the complex     determinant  of complex square matrix;  
!    MatDetermtZ_LogDet --> Subroutine to calculate the complex log(determinant) of complex square matrix. 
!  
!    MatDetermtR_Det    --> Subroutine to calculate the real        determinant  of real square matrix;  
!    MatDetermtR_LogDet --> Subroutine to calculate the complex log(determinant) of real square matrix. 
!             
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



!########################################################################################################################
!########################################################################################################################
!########################################################################################################################
!################################################# For Complex Version ##################################################
!################################################# For Complex Version ##################################################
!################################################# For Complex Version ##################################################
!########################################################################################################################
!########################################################################################################################
!########################################################################################################################
   
   

!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatDetermtZ_Det(NDim, zMat, LDA, zDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatDetermtZ_Det(NDim, zMat, LDA, zDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate determinant for complex square matrix.
! KEYWORDS: Calculate Matrix determinant for complex matrix.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix determinant, complex version. 
!
!     Input: NDim --> Dimension of input A matrix;
!            zMat --> Input complex square matrix;
!            LDA  --> Leading dimension og zMat matrix.
!
!     Outpt: zDet --> Complex determinant.     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
      implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                                  ! Dimension of zMat square matrix
      integer LDA
      complex(kind=kind(0.d0)) zDet                 ! Determinant of zMat matrix
		complex(kind=kind(0.d0)) zMat(LDA, *)         ! The input zMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer IError
      integer I1
      integer, allocatable :: ipiv(:)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(ipiv(NDim), stat=ierror)
		if ( ierror /= 0 ) then
         write(*, "('MatDetermtZ_Det: can not allocate enough memory! ierror = ', I4)") ierror
      end if
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Creating matrix _________________________________________
!______________________________________________________________________________________________________________
		call ZGETRF(NDim, NDim, zMat, LDA, ipiv, Ierror)
      if ( ierror /= 0 ) then
         write(*, "('MatDetermtZ_Det: error in lapack subroutine ZGETRF! ierror = ', I4)") ierror
      end if
      
      zDet = dcmplx(1.0d0, 0.0d0)
      do I1 = 1, ndim
         if( ipiv(I1) == I1 ) then
            zDet = zDet * ( +zMat(I1, I1) )
         else
            zDet = zDet * ( -zMat(I1, I1) )
         end if  
     enddo
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated(ipiv)) deallocate(ipiv)
		
   end subroutine MatDetermtZ_Det
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
 
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatDetermtZ_LogDet(NDim, zMat, LDA, LogzDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatDetermtZ_LogDet(NDim, zMat, LDA, LogzDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate determinant for complex square matrix.
! KEYWORDS: Calculate Matrix determinant for complex matrix.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix determinant, complex version. 
!
!     Input: NDim --> Dimension of input A matrix;
!            zMat --> Input complex square matrix;
!            LDA  --> Leading dimension of zMat matrix.
!
!     Outpt: LogzDet --> Log of Complex determinant.     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                                  ! Dimension of zMat square matrix
      integer LDA
      complex(kind=kind(0.d0)) LogzDet              ! Determinant of zMat matrix
		complex(kind=kind(0.d0)) zMat(LDA, *)         ! The input zMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer IError
      integer I1
      integer Itp0
      
      real(kind=kind(0.d0)) rp_pi
      real(kind=kind(0.d0)) ReLogzDet
      real(kind=kind(0.d0)) ImLogzDet
      
      integer, allocatable :: ipiv(:)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(ipiv(NDim), stat=ierror)
		if ( ierror /= 0 ) then
         write(*, "('MatDetermtZ_LogDet: can not allocate enough memory! ierror = ', I4)") ierror
      end if
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Creating matrix _________________________________________
!______________________________________________________________________________________________________________
		call ZGETRF(NDim, NDim, zMat, LDA, ipiv, Ierror)
      if ( ierror /= 0 ) then
         write(*, "('MatDetermtZ_LogDet: error in lapack subroutine ZGETRF! ierror = ', I4)") ierror
      end if
      
      LogzDet = dcmplx(0.0d0, 0.0d0)
      do I1 = 1, NDim
         if( ipiv(I1) == I1 ) then
            LogzDet = LogzDet + log(+zMat(I1, I1))
         else
            LogzDet = LogzDet + log(-zMat(I1, I1))
         end if  
      enddo
      
      rp_pi = dacos( -1.0d0 )
      ReLogzDet = dreal(LogzDet)
      ImLogzDet = dimag(LogzDet)
      Itp0 = nint(ImLogzDet/2.0d0/rp_pi)
      ImLogzDet = ImLogzDet - 2.0d0*rp_pi*dble(Itp0)
      LogzDet = dcmplx(ReLogzDet, ImLogzDet)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated(ipiv)) deallocate(ipiv)
		
   end subroutine MatDetermtZ_LogDet
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
   
!########################################################################################################################
!########################################################################################################################
!########################################################################################################################
!################################################# For Real Version #####################################################
!################################################# For Real Version #####################################################
!################################################# For Real Version #####################################################
!########################################################################################################################
!########################################################################################################################
!########################################################################################################################
   
   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatDetermtR_Det(NDim, dMat, LDA, dDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatDetermtR_Det(NDim, dMat, LDA, dDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate determinant for real square matrix.
! KEYWORDS: Calculate Matrix determinant for real matrix.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix determinant, real version. 
!
!     Input: NDim --> Dimension of input dMat matrix;
!            dMat --> Input real square matrix;
!            LDA  --> Leading dimension of dMat matrix.
!
!     Outpt: dDet --> Determinant of dMat matrix
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                               ! Dimension of A square matrix
      integer LDA
      real(kind=kind(0.d0)) dDet
		real(kind=kind(0.d0)) dMat(LDA, *)         ! The input A matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer IError
      integer I1
      integer, allocatable :: ipiv(:)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(ipiv(NDim), stat=ierror)
		if ( ierror /= 0 ) then
         write(*, "('MatDetermtR_Det: can not allocate enough memory! ierror = ', I4)") ierror
      end if
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of calculating Det _________________________________________
!______________________________________________________________________________________________________________
		call DGETRF(NDim, NDim, dMat, LDA, ipiv, Ierror)
      if ( ierror /= 0 ) then
         write(*, "('MatDetermtR_Det: error in lapack subroutine DGETRF! ierror = ', I4)") ierror
      end if
      
      dDet = 1.0d0
      do I1 = 1, Ndim
         if( ipiv(I1) == I1 ) then
            dDet = dDet * ( +dMat(I1, I1) )
         else
            dDet = dDet * ( -dMat(I1, I1) )
         end if
      enddo
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated(ipiv)) deallocate(ipiv)
		
   end subroutine MatDetermtR_Det
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatDetermtR_LogDet(NDim, dMat, LDA, LogzDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatDetermtR_LogDet(NDim, dMat, LDA, LogzDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate determinant for real square matrix.
! KEYWORDS: Calculate Matrix determinant for real matrix.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix determinant, real version. 
!
!     Input: NDim --> Dimension of input dMat matrix;
!            dMat --> Input real square matrix;
!
!     Outpt: LogzDet --> Log of Determinant of dMat matrix
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                               ! Dimension of A square matrix
      integer LDA
      complex(kind=kind(0.d0)) LogzDet
		real(kind=kind(0.d0)) dMat(LDA, *)         ! The input A matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer IError
      integer I1
      integer Itp0
      
      real(kind=kind(0.d0)) rp_pi
      real(kind=kind(0.d0)) ReLogzDet
      real(kind=kind(0.d0)) ImLogzDet
      
      integer, allocatable :: ipiv(:)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(ipiv(NDim), stat=ierror)
		if ( ierror /= 0 ) then
         write(*, "('MatDetermtR_LogDet: can not allocate enough memory! ierror = ', I4)") ierror
      end if
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of calculating Det _________________________________________
!______________________________________________________________________________________________________________
		call DGETRF(NDim, NDim, dMat, LDA, ipiv, Ierror)
      if ( ierror /= 0 ) then
         write(*, "('MatDetermtR_LogDet: error in lapack subroutine DGETRF! ierror = ', I4)") ierror
      end if
      
      LogzDet = dcmplx(0.0d0, 0.0d0)
      do I1 = 1, NDim, +1
         if( ipiv(I1) == I1 ) then
            LogzDet = LogzDet + log(dcmplx(+dMat(I1, I1), 0.d0))
         else
            LogzDet = LogzDet + log(dcmplx(-dMat(I1, I1), 0.d0))
         end if 
      enddo
      
      rp_pi = dacos( -1.0d0 )
      ReLogzDet = dreal(LogzDet)
      ImLogzDet = dimag(LogzDet)
      Itp0 = nint(ImLogzDet/2.0d0/rp_pi)
      ImLogzDet = ImLogzDet - 2.0d0*rp_pi*dble(Itp0)
      LogzDet = dcmplx(ReLogzDet, ImLogzDet)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated(ipiv)) deallocate(ipiv)
		
   end subroutine MatDetermtR_LogDet
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
