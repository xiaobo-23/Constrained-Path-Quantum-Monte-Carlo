!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! PROGRAM: Several subroutines used to calculate the matrix inverse for real and complex square matrices separately.
!              There are also alternative subroutines used to calculate both the inverse and determinant for matrices.
!          Need the LAPACK mathematical library.
!          Note: A real matrix must have real matrix determinant.
!        
!          These subroutines calculate matrix inverse by QR decomposition method. Q is a unitary matrix.
!          A = Q*R with L as lower-triangular matrix with U as upper-triangular matrix, and diagonal elements of L are one.
!          det(A) = det(Q*R) = det(Q) * det(R).
!          inv(A) = inv(Q*R) = inv(R) * inv(Q) = inv(R) * Q^+
!
! COMMENT: Common file.  
! AUTHOR:  Yuan-Yao He
! DATE:    2020-02-27
! PURPOSE: Different subroutines are introduced as following:
!
!    MatrxInvQRZ_NoDet  --> Subroutine to calculate the inverse of complex square matrix without  determinant ;  
!    MatrxInvQRZ_Det    --> Subroutine to calculate the inverse of complex square matrix with     determinant ;
!    MatrxInvQRZ_LogDet --> Subroutine to calculate the inverse of complex square matrix with log(determinant);
!  
!    MatrxInvQRR_NoDet  --> Subroutine to calculate the inverse of real square matrix without  determinant ; 
!    MatrxInvQRR_Det    --> Subroutine to calculate the inverse of real square matrix with     determinant ; 
!    MatrxInvQRR_LogDet --> Subroutine to calculate the inverse of real square matrix with log(determinant);
!             
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   
   
   

!########################################################################################################################
!########################################################################################################################
!########################################################################################################################
!################################################# For Complex Version ##################################################
!################################################# For Complex Version ##################################################
!################################################# For Complex Version ##################################################
!########################################################################################################################
!########################################################################################################################
!########################################################################################################################
   

   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatrxInvQRZ_NoDet(NDim, zMat)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatrxInvQRZ_NoDet(NDim, zMat)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate the matrix inverse for complex square matrix and its determinant, and 
!                  the input A is overwrite by Inv(A).
! KEYWORDS: Calculate Matrix inverse, complex version.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix inverse, complex version. 
!
!     Input: NDim --> Dimension of input zMat matrix;
!            zMat --> Input complex square matrix;
!
!     Outpt: zMat --> Result output complex inv matrix of A matrix.     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                     ! Dimension of zMat square matrix
		complex(kind=kind(0.d0)) zMat(NDim, NDim)     ! The input zMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer info
      integer lwork
      
      integer I1, I2

      complex(kind=kind(0.d0)) Ztp1, Ztp2
      
      complex(kind=kind(0.d0)), allocatable :: work(:)
      complex(kind=kind(0.d0)), allocatable ::  tau(:)
      
      complex(kind=kind(0.d0)), allocatable :: QMat(:, :)
      complex(kind=kind(0.d0)), allocatable :: RMat(:, :)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(QMat(NDim, NDim))
      allocate(RMat(NDim, NDim))
      QMat = dcmplx(0.0d0, 0.0d0)
      RMat = dcmplx(0.0d0, 0.0d0)
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Matrix Inverse by QR decomposition ______________________
!______________________________________________________________________________________________________________
!_______________________________________________________________________________________________  
!___________________________ 0. Calculate zMat = QMat * RMat ___________________________________
!_______________________________________________________________________________________________  
!___________________________________________________________________________________
!_____________________ (0) Query optimal amount of memory __________________________
!___________________________________________________________________________________
      allocate(tau(NDim))
      allocate(work(1))
      info = 0
      call zgeqrf(NDim, NDim, zMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
!___________________________________________________________________________________  
!_____________________ (1) Perform QR decomposition for zMat _______________________
!___________________________________________________________________________________
      allocate(work(lwork))
      call zgeqrf(NDim, NDim, zMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 1. Obtain the Q matrix ____________________________________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) Store the reflectors ____________________________________ 
!___________________________________________________________________________________ 
      QMat = dcmplx(0.0d0, 0.0d0)
      do I2 = 1, NDim-1
         do I1 = I2+1, NDim
            QMat(I1, I2) = zMat(I1, I2)
         enddo
      enddo
!___________________________________________________________________________________  
!_____________________ (1) Get Q matrix from the reflectors ________________________
!___________________________________________________________________________________
      allocate(work(1))
      info = 0
      call zungqr(NDim, NDim, NDim, QMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
      
      allocate(work(lwork))
      call zungqr(NDim, NDim, NDim, QMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 2. Get the inverse of R matrix inv(R) _____________________________
!_______________________________________________________________________________________________
      call ZTRTRI("U", "N", NDim, zMat, NDim, info)
      
      RMat = dcmplx(0.0d0, 0.0d0)
      do I2 = 1, NDim
         do I1 = 1, I2
            RMat(I1, I2) = zMat(I1, I2)
         enddo
      enddo
!_______________________________________________________________________________________________  
!___________________________ 3. Get the inverse of zMat  as ____________________________________
!___________________ inv(zMat) = inv(QR) = inv(R) * inv(Q) = inv(R) * Q^+ ______________________
!_______________________________________________________________________________________________
      zMat = dcmplx(0.0d0, 0.0d0)
      
      Ztp1 = dcmplx(1.0d0, 0.0d0)
      Ztp2 = dcmplx(0.0d0, 0.0d0)
      call zgemm("N", "C", NDim, NDim, NDim, Ztp1, RMat, NDim, QMat, NDim, Ztp2, zMat, NDim)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated( tau)) deallocate( tau)
		if(allocated(work)) deallocate(work)
      if(allocated(RMat)) deallocate(RMat)
		if(allocated(QMat)) deallocate(QMat)
		
   end subroutine MatrxInvQRZ_NoDet
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatrxInvQRZ_Det(NDim, zMat, zDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatrxInvQRZ_Det(NDim, zMat, zDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate the matrix inverse for complex square matrix and its determinant, and 
!                  the input A is overwrite by Inv(A).
! KEYWORDS: Calculate Matrix inverse, complex version.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix inverse, complex version. 
!
!     Input: NDim --> Dimension of input zMat matrix;
!            zMat --> Input complex square matrix;
!
!     Outpt: zMat --> Result output complex inv matrix of A matrix.
!            zDet --> Complex determinant.     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                     ! Dimension of zMat square matrix
      complex(kind=kind(0.d0)) zDet                 ! Determinant of zMat matrix
		complex(kind=kind(0.d0)) zMat(NDim, NDim)     ! The input zMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer info
      integer lwork
      
      integer I0, I1, I2
      
      complex(kind=kind(0.d0)) zDetQ
      complex(kind=kind(0.d0)) zDetR
      
      complex(kind=kind(0.d0)) Ztp1, Ztp2
      
      complex(kind=kind(0.d0)), allocatable :: work(:)
      complex(kind=kind(0.d0)), allocatable ::  tau(:)
      
      complex(kind=kind(0.d0)), allocatable :: QMat(:, :)
      complex(kind=kind(0.d0)), allocatable :: RMat(:, :)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(QMat(NDim, NDim))
      allocate(RMat(NDim, NDim))
      QMat = dcmplx(0.0d0, 0.0d0)
      RMat = dcmplx(0.0d0, 0.0d0)
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Matrix Inverse by QR decomposition ______________________
!______________________________________________________________________________________________________________
!_______________________________________________________________________________________________  
!___________________________ 0. Calculate zMat = QMat * RMat ___________________________________
!_______________________________________________________________________________________________  
!___________________________________________________________________________________
!_____________________ (0) Query optimal amount of memory __________________________
!___________________________________________________________________________________
      allocate(tau(NDim))
      allocate(work(1))
      info = 0
      call zgeqrf(NDim, NDim, zMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
!___________________________________________________________________________________  
!_____________________ (1) Perform QR decomposition for zMat _______________________
!___________________________________________________________________________________
      allocate(work(lwork))
      call zgeqrf(NDim, NDim, zMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 1. Get the determinant of Q matrix ________________________________
!_______________________________________________________________________________________________  
      zDetQ = dcmplx(1.0d0, 0.0d0)
      do I0 = 1, NDim
         if( abs(tau(I0)) .ne. 0.0d0 ) then
            Ztp1 = 2.0d0 * tau(I0) * dcmplx(dreal(tau(I0)), 0.0d0)
            Ztp2 = tau(I0) * dconjg(tau(I0))
            zDetQ = zDetQ * ( dcmplx(1.0d0, 0.0d0) - Ztp1/Ztp2 )
         end if
      enddo
!_______________________________________________________________________________________________  
!___________________________ 2. Obtain the Q matrix ____________________________________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) Store the reflectors ____________________________________ 
!___________________________________________________________________________________ 
      QMat = dcmplx(0.0d0, 0.0d0)
      do I2 = 1, NDim-1
         do I1 = I2+1, NDim
            QMat(I1, I2) = zMat(I1, I2)
         enddo
      enddo
!___________________________________________________________________________________  
!_____________________ (1) Get Q matrix from the reflectors ________________________
!___________________________________________________________________________________
      allocate(work(1))
      info = 0
      call zungqr(NDim, NDim, NDim, QMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
      
      allocate(work(lwork))
      call zungqr(NDim, NDim, NDim, QMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 3. Get the determinant of R matrix and total ______________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) The determinant of R matrix _____________________________
!___________________________________________________________________________________ 
      zDetR = dcmplx(1.0d0, 0.0d0)
      do I0 = 1, NDim
         zDetR = zDetR * zMat(I0, I0)
      enddo
!___________________________________________________________________________________  
!_____________________ (1) The total determinant of (QR) matrix ____________________
!___________________________________________________________________________________
      zDet = zDetQ * zDetR
!_______________________________________________________________________________________________  
!___________________________ 4. Get the inverse of R matrix inv(R) _____________________________
!_______________________________________________________________________________________________
      call ZTRTRI("U", "N", NDim, zMat, NDim, info)
      
      RMat = dcmplx(0.0d0, 0.0d0)
      do I2 = 1, NDim
         do I1 = 1, I2
            RMat(I1, I2) = zMat(I1, I2)
         enddo
      enddo
!_______________________________________________________________________________________________  
!___________________________ 5. Get the inverse of zMat  as ____________________________________
!___________________ inv(zMat) = inv(QR) = inv(R) * inv(Q) = inv(R) * Q^+ ______________________
!_______________________________________________________________________________________________
      zMat = dcmplx(0.0d0, 0.0d0)
      
      Ztp1 = dcmplx(1.0d0, 0.0d0)
      Ztp2 = dcmplx(0.0d0, 0.0d0)
      call zgemm("N", "C", NDim, NDim, NDim, Ztp1, RMat, NDim, QMat, NDim, Ztp2, zMat, NDim)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated( tau)) deallocate( tau)
		if(allocated(work)) deallocate(work)
      if(allocated(RMat)) deallocate(RMat)
		if(allocated(QMat)) deallocate(QMat)
		
   end subroutine MatrxInvQRZ_Det
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatrxInvQRZ_LogDet(NDim, zMat, LogzDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatrxInvQRZ_LogDet(NDim, zMat, LogzDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate the matrix inverse for complex square matrix and its determinant, and 
!                  the input A is overwrite by Inv(A).
! KEYWORDS: Calculate Matrix inverse, complex version.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix inverse, complex version. 
!
!     Input: NDim --> Dimension of input zMat matrix;
!            zMat --> Input complex square matrix;
!
!     Outpt: zMat --> Result output complex inv matrix of A matrix.
!            LogzDet --> Complex log(determinant).     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                     ! Dimension of zMat square matrix
      complex(kind=kind(0.d0)) LogzDet              ! Determinant of zMat matrix
		complex(kind=kind(0.d0)) zMat(NDim, NDim)     ! The input zMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer info
      integer lwork
      
      integer I0, I1, I2
      integer Itp0
      
      real(kind=kind(0.d0)) rp_pi
      real(kind=kind(0.d0)) ReLogzDet
      real(kind=kind(0.d0)) ImLogzDet
      
      complex(kind=kind(0.d0)) zLogDetQ
      complex(kind=kind(0.d0)) zLogDetR
      
      complex(kind=kind(0.d0)) Ztp1, Ztp2
      
      complex(kind=kind(0.d0)), allocatable :: work(:)
      complex(kind=kind(0.d0)), allocatable ::  tau(:)
      
      complex(kind=kind(0.d0)), allocatable :: QMat(:, :)
      complex(kind=kind(0.d0)), allocatable :: RMat(:, :)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(QMat(NDim, NDim))
      allocate(RMat(NDim, NDim))
      QMat = dcmplx(0.0d0, 0.0d0)
      RMat = dcmplx(0.0d0, 0.0d0)
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Matrix Inverse by QR decomposition ______________________
!______________________________________________________________________________________________________________
!_______________________________________________________________________________________________  
!___________________________ 0. Calculate zMat = QMat * RMat ___________________________________
!_______________________________________________________________________________________________  
!___________________________________________________________________________________
!_____________________ (0) Query optimal amount of memory __________________________
!___________________________________________________________________________________
      allocate(tau(NDim))
      allocate(work(1))
      info = 0
      call zgeqrf(NDim, NDim, zMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
!___________________________________________________________________________________  
!_____________________ (1) Perform QR decomposition for zMat _______________________
!___________________________________________________________________________________
      allocate(work(lwork))
      call zgeqrf(NDim, NDim, zMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 1. Get the determinant of Q matrix ________________________________
!_______________________________________________________________________________________________  
      zLogDetQ = dcmplx(0.0d0, 0.0d0)
      do I0 = 1, NDim
         if( abs(tau(I0)) .ne. 0.0d0 ) then
            Ztp1 = 2.0d0 * tau(I0) * dcmplx(dreal(tau(I0)), 0.0d0)
            Ztp2 = tau(I0) * dconjg(tau(I0))
            zLogDetQ = zLogDetQ + log( dcmplx(1.0d0, 0.0d0) - Ztp1/Ztp2 )
         end if
      enddo
!_______________________________________________________________________________________________  
!___________________________ 2. Obtain the Q matrix ____________________________________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) Store the reflectors ____________________________________ 
!___________________________________________________________________________________ 
      QMat = dcmplx(0.0d0, 0.0d0)
      do I2 = 1, NDim-1
         do I1 = I2+1, NDim
            QMat(I1, I2) = zMat(I1, I2)
         enddo
      enddo
!___________________________________________________________________________________  
!_____________________ (1) Get Q matrix from the reflectors ________________________
!___________________________________________________________________________________
      allocate(work(1))
      info = 0
      call zungqr(NDim, NDim, NDim, QMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
      
      allocate(work(lwork))
      call zungqr(NDim, NDim, NDim, QMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 3. Get the determinant of R matrix and total ______________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) The determinant of R matrix _____________________________
!___________________________________________________________________________________ 
      zLogDetR = dcmplx(0.0d0, 0.0d0)
      do I0 = 1, NDim
         zLogDetR = zLogDetR + log(zMat(I0, I0))
      enddo
!___________________________________________________________________________________  
!_____________________ (1) The total determinant of (QR) matrix ____________________
!___________________________________________________________________________________
      LogzDet = zLogDetQ + zLogDetR
      
      rp_pi = dacos( -1.0d0 )
      ReLogzDet = dreal(LogzDet)
      ImLogzDet = dimag(LogzDet)
      Itp0 = nint(ImLogzDet/2.0d0/rp_pi)
      ImLogzDet = ImLogzDet - 2.0d0*rp_pi*dble(Itp0)
      LogzDet = dcmplx(ReLogzDet, ImLogzDet)
!_______________________________________________________________________________________________  
!___________________________ 4. Get the inverse of R matrix inv(R) _____________________________
!_______________________________________________________________________________________________
      call ZTRTRI("U", "N", NDim, zMat, NDim, info)
      
      RMat = dcmplx(0.0d0, 0.0d0)
      do I2 = 1, NDim
         do I1 = 1, I2
            RMat(I1, I2) = zMat(I1, I2)
         enddo
      enddo
!_______________________________________________________________________________________________  
!___________________________ 5. Get the inverse of zMat  as ____________________________________
!___________________ inv(zMat) = inv(QR) = inv(R) * inv(Q) = inv(R) * Q^+ ______________________
!_______________________________________________________________________________________________
      zMat = dcmplx(0.0d0, 0.0d0)
      
      Ztp1 = dcmplx(1.0d0, 0.0d0)
      Ztp2 = dcmplx(0.0d0, 0.0d0)
      call zgemm("N", "C", NDim, NDim, NDim, Ztp1, RMat, NDim, QMat, NDim, Ztp2, zMat, NDim)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated( tau)) deallocate( tau)
		if(allocated(work)) deallocate(work)
      if(allocated(RMat)) deallocate(RMat)
		if(allocated(QMat)) deallocate(QMat)
		
   end subroutine MatrxInvQRZ_LogDet
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   

   
   
!########################################################################################################################
!########################################################################################################################
!########################################################################################################################
!################################################# For Real Version #####################################################
!################################################# For Real Version #####################################################
!################################################# For Real Version #####################################################
!########################################################################################################################
!########################################################################################################################
!######################################################################################################################## 
   

   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatrxInvQRR_NoDet(NDim, dMat)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatrxInvQRR_NoDet(NDim, dMat)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate the matrix inverse for real square matrix and its determinant, and 
!                  the input A is overwrite by Inv(A).
! KEYWORDS: Calculate Matrix inverse, real version.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix inverse, real version. 
!
!     Input: NDim --> Dimension of input dMat matrix;
!            dMat --> Input real square matrix;
!
!     Outpt: dMat --> Result output real inv matrix of A matrix.     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                     ! Dimension of dMat square matrix
		real(kind=kind(0.d0)) dMat(NDim, NDim)        ! The input dMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer info
      integer lwork
      
      integer I1, I2
      
      real(kind=kind(0.d0)), allocatable :: work(:)
      real(kind=kind(0.d0)), allocatable ::  tau(:)
      
      real(kind=kind(0.d0)), allocatable :: QMat(:, :)
      real(kind=kind(0.d0)), allocatable :: RMat(:, :)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(QMat(NDim, NDim))
      allocate(RMat(NDim, NDim))
      QMat = 0.0d0
      RMat = 0.0d0
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Matrix Inverse by QR decomposition ______________________
!______________________________________________________________________________________________________________
!_______________________________________________________________________________________________  
!___________________________ 0. Calculate dMat = QMat * RMat ___________________________________
!_______________________________________________________________________________________________  
!___________________________________________________________________________________
!_____________________ (0) Query optimal amount of memory __________________________
!___________________________________________________________________________________
      allocate(tau(NDim))
      allocate(work(1))
      info = 0
      call dgeqrf(NDim, NDim, dMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
!___________________________________________________________________________________  
!_____________________ (1) Perform QR decomposition for dMat _______________________
!___________________________________________________________________________________
      allocate(work(lwork))
      call dgeqrf(NDim, NDim, dMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 1. Obtain the Q matrix ____________________________________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) Store the reflectors ____________________________________ 
!___________________________________________________________________________________ 
      QMat = 0.0d0
      do I2 = 1, NDim-1
         do I1 = I2+1, NDim
            QMat(I1, I2) = dMat(I1, I2)
         enddo
      enddo
!___________________________________________________________________________________  
!_____________________ (1) Get Q matrix from the reflectors ________________________
!___________________________________________________________________________________
      allocate(work(1))
      info = 0
      call dorg2r(NDim, NDim, NDim, QMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
      
      allocate(work(lwork))
      call dorg2r(NDim, NDim, NDim, QMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 2. Get the inverse of R matrix inv(R) _____________________________
!_______________________________________________________________________________________________
      call DTRTRI("U", "N", NDim, dMat, NDim, info)
      
      RMat = 0.0d0
      do I2 = 1, NDim
         do I1 = 1, I2
            RMat(I1, I2) = dMat(I1, I2)
         enddo
      enddo
!_______________________________________________________________________________________________  
!___________________________ 3. Get the inverse of dMat  as ____________________________________
!___________________ inv(dMat) = inv(QR) = inv(R) * inv(Q) = inv(R) * Q^T ______________________
!_______________________________________________________________________________________________
      dMat = 0.0d0
      call dgemm("N", "T", NDim, NDim, NDim, 1.0d0, RMat, NDim, QMat, NDim, 0.0d0, dMat, NDim)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated( tau)) deallocate( tau)
		if(allocated(work)) deallocate(work)
      if(allocated(RMat)) deallocate(RMat)
		if(allocated(QMat)) deallocate(QMat)
		
   end subroutine MatrxInvQRR_NoDet
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatrxInvQRR_Det(NDim, dMat, dDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatrxInvQRR_Det(NDim, dMat, dDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate the matrix inverse for real square matrix and its determinant, and 
!                  the input A is overwrite by Inv(A).
! KEYWORDS: Calculate Matrix inverse, real version.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix inverse, real version. 
!
!     Input: NDim --> Dimension of input dMat matrix;
!            dMat --> Input real square matrix;
!
!     Outpt: dMat --> Result output real inv matrix of A matrix.
!            dDet --> real determinant.     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                     ! Dimension of dMat square matrix
      real(kind=kind(0.d0)) dDet                    ! Determinant of dMat matrix
		real(kind=kind(0.d0)) dMat(NDim, NDim)        ! The input dMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer info
      integer lwork
      
      integer I0, I1, I2
      
      real(kind=kind(0.d0)) dDetQ
      real(kind=kind(0.d0)) dDetR

      real(kind=kind(0.d0)), allocatable :: work(:)
      real(kind=kind(0.d0)), allocatable ::  tau(:)
      
      real(kind=kind(0.d0)), allocatable :: QMat(:, :)
      real(kind=kind(0.d0)), allocatable :: RMat(:, :)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(QMat(NDim, NDim))
      allocate(RMat(NDim, NDim))
      QMat = 0.0d0
      RMat = 0.0d0
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Matrix Inverse by QR decomposition ______________________
!______________________________________________________________________________________________________________
!_______________________________________________________________________________________________  
!___________________________ 0. Calculate dMat = QMat * RMat ___________________________________
!_______________________________________________________________________________________________  
!___________________________________________________________________________________
!_____________________ (0) Query optimal amount of memory __________________________
!___________________________________________________________________________________
      allocate(tau(NDim))
      allocate(work(1))
      info = 0
      call dgeqrf(NDim, NDim, dMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
!___________________________________________________________________________________  
!_____________________ (1) Perform QR decomposition for dMat _______________________
!___________________________________________________________________________________
      allocate(work(lwork))
      call dgeqrf(NDim, NDim, dMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 1. Get the determinant of Q matrix ________________________________
!_______________________________________________________________________________________________  
      dDetQ = 1.0d0
      do I0 = 1, NDim
         if( abs(tau(I0)) .ne. 0.0d0 ) then
            dDetQ = dDetQ * (-1.0d0)
         end if
      enddo
!_______________________________________________________________________________________________  
!___________________________ 2. Obtain the Q matrix ____________________________________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) Store the reflectors ____________________________________ 
!___________________________________________________________________________________ 
      QMat = 0.0d0
      do I2 = 1, NDim-1
         do I1 = I2+1, NDim
            QMat(I1, I2) = dMat(I1, I2)
         enddo
      enddo
!___________________________________________________________________________________  
!_____________________ (1) Get Q matrix from the reflectors ________________________
!___________________________________________________________________________________
      allocate(work(1))
      info = 0
      call dorg2r(NDim, NDim, NDim, QMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
      
      allocate(work(lwork))
      call dorg2r(NDim, NDim, NDim, QMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 3. Get the determinant of R matrix and total ______________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) The determinant of R matrix _____________________________
!___________________________________________________________________________________ 
      dDetR = 1.0d0
      do I0 = 1, NDim
         dDetR = dDetR * dMat(I0, I0)
      enddo
!___________________________________________________________________________________  
!_____________________ (1) The total determinant of (QR) matrix ____________________
!___________________________________________________________________________________
      dDet = dDetQ * dDetR
!_______________________________________________________________________________________________  
!___________________________ 4. Get the inverse of R matrix inv(R) _____________________________
!_______________________________________________________________________________________________
      call DTRTRI("U", "N", NDim, dMat, NDim, info)
      
      RMat = 0.0d0
      do I2 = 1, NDim
         do I1 = 1, I2
            RMat(I1, I2) = dMat(I1, I2)
         enddo
      enddo
!_______________________________________________________________________________________________  
!___________________________ 5. Get the inverse of dMat as _____________________________________
!___________________ inv(dMat) = inv(QR) = inv(R) * inv(Q) = inv(R) * Q^+ ______________________
!_______________________________________________________________________________________________
      dMat = 0.0d0
      call dgemm("N", "T", NDim, NDim, NDim, 1.0d0, RMat, NDim, QMat, NDim, 0.0d0, dMat, NDim)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated( tau)) deallocate( tau)
		if(allocated(work)) deallocate(work)
      if(allocated(RMat)) deallocate(RMat)
		if(allocated(QMat)) deallocate(QMat)
		
   end subroutine MatrxInvQRR_Det
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________  
	subroutine MatrxInvQRR_LogDet(NDim, dMat, LogzDet)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
! PROGRAM:  MatrxInvQRR_LogDet(NDim, dMat, LogzDet)
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to calculate the matrix inverse for real square matrix and its determinant, and 
!                  the input A is overwrite by Inv(A).
! KEYWORDS: Calculate Matrix inverse, real version.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Calculate Matrix inverse, real version. 
!
!     Input: NDim --> Dimension of input dMat matrix;
!            dMat --> Input real square matrix;
!
!     Outpt: dMat --> Result output real inv matrix of A matrix.
!            LogzDet --> complex log(determinant).     
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 			
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________  
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
		integer NDim                     ! Dimension of dMat square matrix
      complex(kind=kind(0.d0)) LogzDet              ! Determinant of dMat matrix
		real(kind=kind(0.d0)) dMat(NDim, NDim)        ! The input dMat matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer info
      integer lwork
      
      integer I0, I1, I2
      integer Itp0
      
      real(kind=kind(0.d0)) rp_pi
      real(kind=kind(0.d0)) ReLogzDet
      real(kind=kind(0.d0)) ImLogzDet
      
      complex(kind=kind(0.d0)) zLogDetQ
      complex(kind=kind(0.d0)) zLogDetR
      
      real(kind=kind(0.d0)), allocatable :: work(:)
      real(kind=kind(0.d0)), allocatable ::  tau(:)
      
      real(kind=kind(0.d0)), allocatable :: QMat(:, :)
      real(kind=kind(0.d0)), allocatable :: RMat(:, :)
!______________________________________________________________________________________________________________	  
!__________________________________ Allocate Array and Initializations ________________________________________
!______________________________________________________________________________________________________________
		allocate(QMat(NDim, NDim))
      allocate(RMat(NDim, NDim))
      QMat = 0.0d0
      RMat = 0.0d0
!______________________________________________________________________________________________________________	  
!_______________________________ Main calculations of Matrix Inverse by QR decomposition ______________________
!______________________________________________________________________________________________________________
!_______________________________________________________________________________________________  
!___________________________ 0. Calculate dMat = QMat * RMat ___________________________________
!_______________________________________________________________________________________________  
!___________________________________________________________________________________
!_____________________ (0) Query optimal amount of memory __________________________
!___________________________________________________________________________________
      allocate(tau(NDim))
      allocate(work(1))
      info = 0
      call dgeqrf(NDim, NDim, dMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
!___________________________________________________________________________________  
!_____________________ (1) Perform QR decomposition for dMat _______________________
!___________________________________________________________________________________
      allocate(work(lwork))
      call dgeqrf(NDim, NDim, dMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 1. Get the determinant of Q matrix ________________________________
!_______________________________________________________________________________________________  
      zLogDetQ = dcmplx(0.0d0, 0.0d0)
      do I0 = 1, NDim
         if( abs(tau(I0)) .ne. 0.0d0 ) then
            zLogDetQ = zLogDetQ + log( dcmplx(-1.0d0, 0.0d0) )
         end if
      enddo
!_______________________________________________________________________________________________  
!___________________________ 2. Obtain the Q matrix ____________________________________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) Store the reflectors ____________________________________ 
!___________________________________________________________________________________ 
      QMat = 0.0d0
      do I2 = 1, NDim-1
         do I1 = I2+1, NDim
            QMat(I1, I2) = dMat(I1, I2)
         enddo
      enddo
!___________________________________________________________________________________  
!_____________________ (1) Get Q matrix from the reflectors ________________________
!___________________________________________________________________________________
      allocate(work(1))
      info = 0
      call dorg2r(NDim, NDim, NDim, QMat, NDim, tau, work, -1, info)
      lwork = int(dble(work(1)))
      deallocate(work)
      
      allocate(work(lwork))
      call dorg2r(NDim, NDim, NDim, QMat, NDim, tau, work, lwork, info)
      deallocate(work)
!_______________________________________________________________________________________________  
!___________________________ 3. Get the determinant of R matrix and total ______________________
!_______________________________________________________________________________________________
!___________________________________________________________________________________  
!_____________________ (0) The determinant of R matrix _____________________________
!___________________________________________________________________________________ 
      zLogDetR = dcmplx(0.0d0, 0.0d0)
      do I0 = 1, NDim
         zLogDetR = zLogDetR + log(dcmplx(dMat(I0, I0), 0.0d0))
      enddo
!___________________________________________________________________________________  
!_____________________ (1) The total determinant of (QR) matrix ____________________
!___________________________________________________________________________________
      LogzDet = zLogDetQ + zLogDetR
      
      rp_pi = dacos( -1.0d0 )
      ReLogzDet = dreal(LogzDet)
      ImLogzDet = dimag(LogzDet)
      Itp0 = nint(ImLogzDet/2.0d0/rp_pi)
      ImLogzDet = ImLogzDet - 2.0d0*rp_pi*dble(Itp0)
      LogzDet = dcmplx(ReLogzDet, ImLogzDet)
!_______________________________________________________________________________________________  
!___________________________ 4. Get the inverse of R matrix inv(R) _____________________________
!_______________________________________________________________________________________________
      call DTRTRI("U", "N", NDim, dMat, NDim, info)
      
      RMat = 0.0d0
      do I2 = 1, NDim
         do I1 = 1, I2
            RMat(I1, I2) = dMat(I1, I2)
         enddo
      enddo
!_______________________________________________________________________________________________  
!___________________________ 5. Get the inverse of dMat  as ____________________________________
!___________________ inv(dMat) = inv(QR) = inv(R) * inv(Q) = inv(R) * Q^T ______________________
!_______________________________________________________________________________________________
      dMat = 0.0d0
      call dgemm("N", "T", NDim, NDim, NDim, 1.0d0, RMat, NDim, QMat, NDim, 0.0d0, dMat, NDim)
!______________________________________________________________________________________________________________	  
!___________________________________________ Deallocate the arrays ____________________________________________
!______________________________________________________________________________________________________________
		if(allocated( tau)) deallocate( tau)
		if(allocated(work)) deallocate(work)
      if(allocated(RMat)) deallocate(RMat)
		if(allocated(QMat)) deallocate(QMat)
		
   end subroutine MatrxInvQRR_LogDet
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
