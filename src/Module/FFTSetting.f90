!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! PROGRAM: A module used to define the Fast Fourier Transformation (FFT) related quantities, used for operating the
!              multiplication of matrix and exponential hopping matrix.
! COMMENT: FFT related quantities.  
! AUTHOR:  Yuan-Yao He
! DATE:    2020-02-27
! PURPOSE: Different subroutines are introduced as following:
!             
!    FFTSetting     --> Subroutine to define  the related quantities for FFT calculations;
!    FFTSettingBgn --> Subroutine to perform the initializations of FFT calculations;
!    FFTSettingEnd --> Subroutine to perform finalization of FFT calculations.
!             
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin Module ______________________________________________________________________
!________________________________________________________________________________________________________________________
	module FFTSetting
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
            use RealPrecsn
		implicit none
!______________________________________________________________________________________________________________	  
!__________________________________ Quantities used in FFT calculations _______________________________________
!______________________________________________________________________________________________________________
!________________________________________________________________________________________ 	  
!_________________ (0) Plans for forward and backward transformations ___________________
!________________________________________________________________________________________
            integer(kind=8) Plan_XK_RC               ! FFT from real space to reciprocal space, real    --> complex
            integer(kind=8) Plan_KX_CR               ! FFT from reciprocal space to real space, complex --> real
            integer(kind=8) Plan_XK_CC               ! FFT from real space to reciprocal space, complex --> complex
            integer(kind=8) Plan_KX_CC               ! FFT from reciprocal space to real space, complex --> complex
!________________________________________________________________________________________ 	  
!_________________ (1) Integer dimension for the R2C and C2R FFT ________________________
!________________________________________________________________________________________
            integer FFTDm
!________________________________________________________________________________________ 	  
!_________________ (2) The IN and OUT vectors for X-->K and K-->X transfs _______________
!________________________________________________________________________________________   
            real(rp)   , allocatable :: FFTVectRNs(:) ! Real    (NumNS) vector
            complex(rp), allocatable :: FFTVectCDm(:) ! complex (FFTDm) vector
            complex(rp), allocatable :: FFTVcApCNs(:) ! complex (NumNS) vector
            complex(rp), allocatable :: FFTVcBtCNs(:) ! complex (NumNS) vector

   end module FFTSetting
!________________________________________________________________________________________________________________________  
!____________________________________ End Module ________________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine FFTSettingBgn()  
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  FFTSettingBgn() 
! TYPE:     subroutine
! PURPOSE:  This Subroutine performs the initialization for the FFTISetting module.
! KEYWORDS: Initialization of the FFTISetting module. 
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: We give the values to the quanties defined in the module FFTISetting. 
!
!     Input:  (none)   Output: (none)
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
            use RealPrecsn
            use CoreParamt
		use FFTSetting
		implicit none
!______________________________________________________________________________________________________________
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________      
            integer FFTThreads, FFTIRet 
!______________________________________________________________________________________________________________	  
!______________________________________ Initialization process ________________________________________________
!______________________________________________________________________________________________________________   
!________________________________________________________________________________________ 	  
!_________________ (0) Initialize the OMP for FFT ifdef OMPTHREADS ______________________
!________________________________________________________________________________________ 
#ifdef OMPTHREADS
      open( 57, err = 98, file = "Input/FFTThreads.txt")
      read( 57, *) FFTThreads
      close(57)
      call dfftw_init_threads(FFTIRet)
      call dfftw_plan_with_nthreads(FFTThreads)
      go to 99

98    continue
      call dfftw_init_threads(FFTIRet)
      call dfftw_plan_with_nthreads(4)
         
99    continue  
#endif
!________________________________________________________________________________________ 	  
!_________________ (1) Dimension of the vector for FFT operations _______________________
!________________________________________________________________________________________
            FFTDm = (NumL1/2 + 1) * NumL2
!________________________________________________________________________________________ 	  
!_________________ (2) Allocate the vectors and matrices used for FFT ___________________
!________________________________________________________________________________________ 
            allocate(FFTVectRNs(NumNS))
            allocate(FFTVectCDm(FFTDm))
            allocate(FFTVcApCNs(NumNS))
            allocate(FFTVcBtCNs(NumNS))
            FFTVectRNs = 0.0_rp
            FFTVectCDm = rp_Zzero
            FFTVcApCNs = rp_Zzero
            FFTVcBtCNs = rp_Zzero
!________________________________________________________________________________________ 	  
!_________________ (3) Create the X-->K and K-->X Plans for FFT _________________________
!________________________________________________________________________________________ 
            call DFFTW_PLAN_DFT_R2C_2D(Plan_XK_RC, NumL1, NumL2, FFTVectRNs, FFTVectCDm, 0)
            call DFFTW_PLAN_DFT_C2R_2D(Plan_KX_CR, NumL1, NumL2, FFTVectCDm, FFTVectRNs, 0)
            call DFFTW_PLAN_DFT_2D(Plan_XK_CC, NumL1, NumL2, FFTVcApCNs, FFTVcBtCNs, -1, 0)
            call DFFTW_PLAN_DFT_2D(Plan_KX_CC, NumL1, NumL2, FFTVcApCNs, FFTVcBtCNs, +1, 0)
      
   end subroutine FFTSettingBgn
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

 
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine FFTSettingEnd()
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  FFTSettingEnd() 
! TYPE:     subroutine
! PURPOSE:  This Subroutine performs the finalization for the FFTSetting module.
! KEYWORDS: Finalization of the FFTSetting module. 
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Finalization of the FFTSetting module. 
!
!     Input:  (none)   Output: (none)
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use FFTSetting
		implicit none
!______________________________________________________________________________________________________________	  
!______________________________________ Finalization process __________________________________________________
!______________________________________________________________________________________________________________
!________________________________________________________________________________________ 	  
!_________________ (0) Deallocate the temporary vectors and matrices ____________________
!________________________________________________________________________________________ 
      if(allocated(FFTVectRNs)) deallocate(FFTVectRNs)
      if(allocated(FFTVectCDm)) deallocate(FFTVectCDm)
      if(allocated(FFTVcApCNs)) deallocate(FFTVcApCNs)
      if(allocated(FFTVcBtCNs)) deallocate(FFTVcBtCNs)
!________________________________________________________________________________________ 	  
!_________________ (1) Destroy the FFT plans ____________________________________________
!________________________________________________________________________________________ 
      call DFFTW_DESTROY_PLAN(Plan_XK_RC)
      call DFFTW_DESTROY_PLAN(Plan_KX_CR)
      call DFFTW_DESTROY_PLAN(Plan_XK_CC)
      call DFFTW_DESTROY_PLAN(Plan_KX_CC)
      
   end subroutine FFTSettingEnd
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
