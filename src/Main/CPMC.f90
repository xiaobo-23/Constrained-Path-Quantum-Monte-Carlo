!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! PROGRAM: A single subroutine to perform the whole CPMC simulations, and count the time consumed by the 
!                      CPMC simulations.
! COMMENT: CPMC simulation process.
! AUTHOR:  Yuan-Yao He
! DATE:    2020-02-27
! PURPOSE: Different subroutines are introduced as following:
!             
!   CPMC --> Subroutine to perform CPMC simulation and count the time consumed by the whole CPMC simulation.
!             
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
   


!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________                            
   subroutine CPMC()
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  CPMC()
! TYPE:     subroutine
! PURPOSE:  This Subroutine perform all the main part of clculations of CPMC, and the total calculation time is 
!                  calculated by subroutines.
! KEYWORDS: Main part of the program
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION:
!
!     Input: (none);  Output: (none).
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this Module ________________________________________
!______________________________________________________________________________________________________________
      use MPISetting
      implicit none    
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
		integer(8) time1 
		integer(8) time2	
!**************************************************************************************************************	  
!_____________________________________ Print the head of the program __________________________________________
!**************************************************************************************************************
      if(amyid == amstr) then
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "( )")
         write(*, "( )")
         write(*, "( )")
      end if
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&      
!______________ 0. Read the model parameters from input file as preparation for CPMC calculations _____________
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&   
      call SubroutineBgn("CPMCReadPara", 6, time1)
      call CPMCReadPara()
      call SubroutineEnd("CPMCReadPara", 6, time1, time2)
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&      
!______________ 1. Perform the CPMC initializations before the CPMC simulation ________________________________
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
      call SubroutineBgn("CPMCInitiate", 6, time1)
      call CPMCInitiate()
      call SubroutineEnd("CPMCInitiate", 6, time1, time2)
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&	      
!______________ 2. Perform the standard CPMC Simulation as the updating process _______________________________
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&     
      call SubroutineBgn("CPMCSimulate", 6, time1)
      call CPMCSimulate()
      call SubroutineEnd("CPMCSimulate", 6, time1, time2)
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&	      
!______________ 3. Perform the CPMC data processing after the whole simulation ________________________________
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
      call SubroutineBgn("CPMCDataProc", 6, time1)
      call CPMCDataProc()
      call SubroutineEnd("CPMCDataProc", 6, time1, time2)
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&      
!______________ 4. Perform the CPMC finalizations after the CPMC simulation ___________________________________
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
      call SubroutineBgn("CPMCFinalize", 6, time1)
      call CPMCFinalize()
      call SubroutineEnd("CPMCFinalize", 6, time1, time2)
!**************************************************************************************************************	  
!_____________________________________ Print the Tail of the program __________________________________________
!**************************************************************************************************************
      if(amyid == amstr) then
         write(*, "( )")
         write(*, "( )")
         write(*, "( )")
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
         write(*, "(A)") "=============================================================================================="
      end if
     
   end subroutine CPMC
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$