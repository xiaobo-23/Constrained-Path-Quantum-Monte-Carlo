!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! PROGRAM: Several subroutines used to compute the Chemical potential for fixed density simulations, by self-consistent
!              QMC calculations.
! COMMENT: Determine ChemP for fixed density.
! AUTHOR:  Yuan-Yao He
! DATE:    2020-02-27
! PURPOSE: Different subroutines are introduced as following:
!  
!   CPMCFixdnT --> Subroutine used to perform all the calculations to determine ChemP.
!             
!   CPMCMeaFix --> Subroutine used to perform the sweep as [0, Beta] to compute electron density;
!   nOccpSignM --> Subroutine used to calculate the density average and error bar;
!
!   ObtainAvgErr --> Subroutine used to obtain the average and error bar.
!          
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
      subroutine CPMCFixdnT()
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  CPMCFixdnT()
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the warm up and measurements of total electron density for the case of
!                  fixed electron density case.
! KEYWORDS: CPMC measurement of total electron density.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Determine the \mu parameter according to the input NumNe/Fix_nT.
!
!     Input:  (none)   Output: (none)
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________     
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
      use RealPrecsn
      use Observable
      use CoreParamt
            use MPISetting
            implicit none
!______________________________________________________________________________________________________________     
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
            integer(8) time1, time2, time3, time4 
      character(40) FlBIN                    ! Write the integer NB into this character 
!______________________________________________________________________________________________________________     
!_______________________________ Main calculations of CPMC Simulation _________________________________________
!______________________________________________________________________________________________________________
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
!_________________________ Monitor output of the process of present subroutine ____________________
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
      if(amyid == amstr) then
         write(*, "()")
         write(*, "(16x, 'CPMCFixdnT: Warm up and measurement for simulations with fixed n_Occ!')")
      end if
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&     
!___________________ 0. Initializations for the self-consistent computation _______________________
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
      !!!!!!!!!! Initialization of nT_Now and nT_Now_Err
      nT_Now     = 0.0_rp
      nT_Now_Err = 0.0_rp
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&     
!___________________ 1. Self-consistent iterations for computating ChemP __________________________
!&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
      do while(abs(nT_Now-Fix_nT) >= nT_Now_Err*0.5_rp)
!________________________________________________________________________________________         
!_________________ (0) Obtain ChemP value for the present iteration _____________________
!________________________________________________________________________________________
         ChemP = ( ChemP_Ref(1) + ChemP_Ref(2) ) / 2.0_rp
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!__________________________________ Counting time consumed for present BIN ____________________________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
         write(FlBIN, "(I3.3, ' Iteration')") Fix_Iterate
         call SubroutineBgn(Trim(FlBIN), 15, time3)
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
!_________________ (1) Monitor output of the number of the present iteration ____________
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
         if(amyid == amstr) then
            write(*, "()")
            write(*, "(28x, 'Fix_Iterate = ', I3.3)") Fix_Iterate
            write(*, "(33x, 'ChemP == ', sp, es23.16)") ChemP
         end if
!________________________________________________________________________________________         
!_________________ (2) Reset the DeltbU_H0T matrix by (H_0-H_T) factor __________________
!________________________________________________________________________________________
         if(amyid == amstr) then
            write(*, "(33x, 'Reset the Exponential interaction matrices!')")
         end if
         call ResetDeltabU()
!________________________________________________________________________________________         
!_________________ (3) The warm up process for the present Fix_Iterate __________________
!________________________________________________________________________________________
         call SubroutineBgn("CPMCWarmUp", 19, time1)
         call CPMCWarmUp() 
         call SubroutineEnd("CPMCWarmUp", 19, time1, time2)
!________________________________________________________________________________________         
!_________________ (4) The sweep for measuring total density ____________________________
!________________________________________________________________________________________
         call SubroutineBgn("CPMCMeaFix", 19, time1)
         call CPMCMeaFix() 
         call SubroutineEnd("CPMCMeaFix", 19, time1, time2)
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!__________________________________ Counting time consumed for present BIN ____________________________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
         call SubroutineEnd(Trim(FlBIN), 15, time3, time4)
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
!_________________ (5) Output settings for the present iteration ________________________
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
         if(amyid == amstr) then
            !!!!!! Monitor output
            write(*, "(33x, 'WghtM =', es23.16, ' +/-', es23.16)") WgtNow, WgtNow_Err
            write(*, "(33x, 'NeNow =', es23.16, ' +/-', es23.16)") Ne_Now, Ne_Now_Err
            write(*, "(33x, 'NeNow - NumNe  =', SP, es24.16)") Ne_Now-NumNe
            write(*, "(33x, 'n_Occ =', es23.16, ' +/-', es23.16)") nT_Now, nT_Now_Err
            write(*, "(33x, 'n_Occ - Fix_nT =', SP, es24.16)") nT_Now-Fix_nT
            !!!!!! Results of the present iteration
            open( 297, file = "Output/00_FixnT_TuneChemP.txt", access = "append")
            write(297, "(I3.3, A, es18.11, A, f15.8, A, f15.8, 4x)", advance = "no") Fix_Iterate, char(9), &
               & ChemP, char(9), WgtNow, char(9), WgtNow_Err
            write(297, "(A, f15.8, A, f15.8, A, f15.8, A, f15.8, 4x, A, SP, f15.8, A, f15.8)") char(9), Ne_Now, &
               & char(9), Ne_Now_Err, char(9), nT_Now, char(9), nT_Now_Err, char(9), Ne_Now-NumNe, char(9), &
               & nT_Now-Fix_nT
            close(297)
         end if
!________________________________________________________________________________________         
!_________________ (6) Prepare parameters for the next iteration ________________________
!________________________________________________________________________________________
         !!!!!!!! Adjust ChemP_Ref(1:2) according to nT_Now and Fix_nT
         ChemP_Ref(1) = merge(ChemP_Ref(1), ChemP, nT_Now >= Fix_nT)
         ChemP_Ref(2) = merge(ChemP, ChemP_Ref(2), nT_Now >= Fix_nT)
         !!!!!!!! Accumulate Fix_Iterate
         Fix_Iterate = Fix_Iterate + 1
      enddo
!&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$$$
!___________________ 2. Reset IfFixnT to be IfFixnT = .false. after convergence ___________________
!&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$&&&&####$$$$$$
      IfFixnT = .false.
            
   end subroutine CPMCFixdnT
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
      subroutine CPMCMeaFix()
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  CPMCMeaFix()
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the measurements of total electron density for the case of
!                  fixed electron density case.
! KEYWORDS: CPMC measurement of total electron density.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Only measure the total electron density.
!
!     Input:  (none)   Output: (none)
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________     
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
      use RealPrecsn
      use TimeRecord
            use QMCTimeRec
            use CoreParamt
      use Observable
      use MPISetting
            implicit none
!______________________________________________________________________________________________________________     
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1, time2
      logical IfMeasure
      integer NB, NSW
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for warm up part process __________________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
            call system_clock(time1)
!______________________________________________________________________________________________________________     
!_______________________________ Main calculations of CPMC Warm up ____________________________________________
!______________________________________________________________________________________________________________
!v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%
!________________________ Call MPI_Barrier to make all the processes synchronous ______________________________
!v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%      
#ifdef MPIPROCESS
      call MPI_Barrier(acomm, ierr) 
#endif
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
!_________________________ Monitor output of CPMCMeaFix process ___________________________________
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
      if(amyid == amstr) then
         write(*, "(33x, 'Perform measure part for present iteration!')")
      end if
!**************************************************************************************************     
!___________________ 0. Some initializations for warm up process __________________________________
!**************************************************************************************************               
!________________________________________________________________________________________         
!_________________ (0) Close Tag for measurements in sweeps and measures ________________
!________________________________________________________________________________________          
      IfMeasure = .true.; NObsStat = 0
      WeightList(:) = + 00.00_rp
      n_Occ_List(:) = - 100.0_rp
      NB = 9000
!________________________________________________________________________________________         
!_________________ (1) Initializations of time-counting module for present BIN __________
!________________________________________________________________________________________             
      call QMCTimeRecInit()
!________________________________________________________________________________________         
!_________________ (2) Setting for outputting information during simulation _____________
!________________________________________________________________________________________      
      StabOutput = NSwepFix / 2
      PoptOutput = NSwepFix - 1
!**************************************************************************************************     
!___________________ 1. Carry out the warm up process for the simulation __________________________
!************************************************************************************************** 
      do NSW = 1, NSwepFix, +1
!________________________________________________________________________________________         
!_________________ (0) Propagate from \tau=0 to \tau=BetaT to sample paths ______________
!_____________________ And perform measurements at \tau=BetaT point _____________________
!________________________________________________________________________________________
         call SweepOne2M(IfMeasure, NB, NSW)
      enddo
!**************************************************************************************************     
!___________________ 2. Store the sampled paths (configurations) and Growth estimator _____________
!**************************************************************************************************
!________________________________________________________________________________________         
!_________________ (0) Store the paths (configurations) from CP construction ____________
!________________________________________________________________________________________
      if(IfSaveFlds) call SaveFewCfg()
!________________________________________________________________________________________         
!_________________ (1) Store the growth estimator _______________________________________
!________________________________________________________________________________________
      call RdWtGrowth("Save")
!**************************************************************************************************     
!___________________ 3. Obtain the average electron density and sign ______________________________
!**************************************************************************************************
      call nOccpSignM()
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for warm up part process __________________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&     
            call system_clock(time2)
      TimeSgBIN = TimeIntrvl(time1, time2)
!**************************************************************************************************     
!___________________ 4. Output consumed time of this starting part of CPMC ________________________
!**************************************************************************************************
      call SaveCalTim(NB)
!v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%
!________________________ Call MPI_Barrier to make all the processes synchronous ______________________________
!v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%      
#ifdef MPIPROCESS
      call MPI_Barrier(acomm, ierr) 
#endif
            
   end subroutine CPMCMeaFix
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
   subroutine nOccpSignM()
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  nOccpSignM()
! TYPE:     subroutine
! PURPOSE:  This Subroutine calculates the average and errorbar value for total electron density and weight.
! KEYWORDS: Mean and ErrorBar.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate the mean and errorbar.
!
!     Input: (none);  Output: (none).
! 
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!______________________________________________________________________________________________________________     
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
            use RealPrecsn
      use CoreParamt
      use Observable
            implicit none
!______________________________________________________________________________________________________________     
!_____________________________ Main calculations electron density and sign ____________________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************     
!___________________ 0. Compute the (nT_Now, nT_Now_Err) and (Ne_Now, Ne_Now_Err) _________________
!**************************************************************************************************
!________________________________________________________________________________________         
!_________________ (0) Sort n_Occ_List __________________________________________________
!________________________________________________________________________________________
      call QuckSortR(1, NObsStat, n_Occ_List(1))
!________________________________________________________________________________________         
!_________________ (1) Obtain mean and errorbar for nTOcc and weights ___________________
!________________________________________________________________________________________   
      call ObtainAvgErr(NObsStat  , WeightList(1), WgtNow, WgtNow_Err)
      call ObtainAvgErr(NObsStat-2, n_Occ_List(2), nT_Now, nT_Now_Err)
!________________________________________________________________________________________         
!_________________ (2) Total number of electrons --> Average and error bar ______________
!________________________________________________________________________________________
      Ne_Now     = nT_Now     * dble(NumNS)
      Ne_Now_Err = nT_Now_Err * dble(NumNS)

   end subroutine nOccpSignM
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   
      
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
      subroutine ObtainAvgErr(NDim, VecA, Avgr, ErrB)
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  ObtainAvgErr(NDim, VecA, Avgr, ErrB)
! TYPE:     subroutine
! PURPOSE:  This Subroutine calculates the average and errorbar value for an array of data VecA(StartIndex:N).
! KEYWORDS: Mean and ErrorBar.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate the mean and errorbar.
!
!     Input:  NDim --> Length of the VecA vector;
!             VecA --> The data vector;
!
!     Output: Avgr --> The mean value of VecA(1:NDim).
! 
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
!______________________________________________________________________________________________________________     
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
            use RealPrecsn
            implicit none
!______________________________________________________________________________________________________________     
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
            integer NDim            ! Ending integer index for data processing
            real(rp) VecA(NDim)     ! Data vector
            real(rp) Avgr           ! Average value
            real(rp) ErrB           ! Error Bar
!______________________________________________________________________________________________________________     
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
            integer I1
!______________________________________________________________________________________________________________     
!_____________________________ Main calculations Mean values and error bar ____________________________________
!______________________________________________________________________________________________________________
      Avgr = 0.0_rp
      do I1 = 1, NDim, +1
         Avgr = Avgr + VecA(I1)
      enddo
      Avgr = Avgr / dble(NDim-1+1)
         
      ErrB = 0.0_rp
      do I1 = 1, NDim, +1
         ErrB = ErrB + (VecA(I1) - Avgr)**2
      enddo
      ErrB = ErrB / dble(NDim) / dble(NDim-1)
      ErrB = sqrt(ErrB)

   end subroutine ObtainAvgErr
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$