!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! PROGRAM: Several subroutines used to perform the starting part of finite-T CPMC simulations.
! COMMENT: Starting part of finite-T CPMC simulations.
! AUTHOR:  Yuan-Yao He
! DATE:    2020-02-27
! PURPOSE: Different subroutines are introduced as following:
!             
!   CPMCSmuBgn --> Subroutine to perform the starting part of finite-T CPMC simulations;
!
!   InitUDVMatrx --> Subroutine to initialize the UDV matrices at beginning of every sweep.
!             
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine CPMCSmuBgn() 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  CPMCSmuBgn() 
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the starting part of calculation for the finite-temperature 
!                  CPMC simulations. G = (I + B_M * B_{M-1} * ... * B_2 * B_1)^{-1}
! KEYWORDS: Starting part of finite-T CPMC simulations.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27.
! DESCRIPTION: For BTSetType == 0 or BTSetType == 1, the calculations are different.
!          (0) For BTSetType == 0 case, we need to initialize the ULeft, DLeftVec, VLeft in B_T matrix and 
!                                                            also URght, DRghtVec, VRght in B_X matrix;
!          (1) For BTSetType == 1 case, we have VLeft * DLeftVec * ULeft = B_M * B_{M-1} * ... * B_2 * B_1
!                                           and URght, DRghtVec, VRght are identity.
!     
!     Input: (none);  Outpt: (none).
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________ 
		use RealPrecsn
            use TimeRecord
		use QMCTimeRec
		use CoreParamt
		use StdInOutSt
            use MPISetting
		implicit none
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1, time2
      integer IWalk, NT, SpnInd
      integer NB, I1, I2
      real(rp) nT_BT, Rtp0, Rtp1
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for starting part process _________________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!____________________________ Main calculations of Starting part of CPMC simulations __________________________
!______________________________________________________________________________________________________________
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
!_________________________ Monitor output of starting CPMCSmuBgn process __________________________
!&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(&(
      if(amyid == amstr) then
         write(*, "()")
         write(*, "(16x, 'CPMCSmuBgn: Perform starting part of CPMC simulation!')")
      end if
!**************************************************************************************************	  
!___________________ 0. Some initializations before the starting part _____________________________
!**************************************************************************************************
!________________________________________________________________________________________ 	  
!_________________ (0) Initialization of time counting quantities _______________________
!________________________________________________________________________________________
      call QMCTimeRecInit()
!________________________________________________________________________________________ 	  
!_________________ (1) Set Warm up with NB == -1 for indexing ___________________________
!________________________________________________________________________________________
      NB = -1
!________________________________________________________________________________________ 	  
!_________________ (2) Initializations of weights for walkers ___________________________
!________________________________________________________________________________________	
      WghtProc = 1.0_rp; Log_Wght = 0.0_rp
!________________________________________________________________________________________ 	  
!_________________ (3) Read the growth estimators from input file _______________________
!________________________________________________________________________________________
      call RdWtGrowth("Read")
!**************************************************************************************************	  
!___________________ 1. Initializatios of UDV and GreenF matrices for FT-CPMC simulations _________
!**************************************************************************************************
!________________________________________________________________________________________ 	  
!_________________ (0) The initial UDV and LogScale for left and right sides ____________
!________________________________________________________________________________________
      call InitUDVMatrx()
!________________________________________________________________________________________ 	  
!_________________ (1) The initial GreenF matrix for H_T Hamiltonian ____________________
!________________________________________________________________________________________
      call InitGrFctMat()
!**************************************************************************************************	  
!___________________ 2. Calculate GreenF and static observables for H_T Hamiltonian _______________
!**************************************************************************************************
      if(.not. IfMuTqmcNt) then
!________________________________________________________________________________________  
!_________________ (0) Calculate some Physical Quantities for H_T Hmlt __________________
!________________________________________________________________________________________
         call PhyMeaStatHT()
!________________________________________________________________________________________  
!_________________ (1) Filling of HT Hamiltonian and output _____________________________
!________________________________________________________________________________________
         call Calculate_nTOfHT(nT_BT)     
#ifdef MPIPROCESS
         call MPI_Barrier(acomm, ierr)
      if( (mod(amyid, merge(anprc/4, 1, anprc>4)) == 0) .or. (amyid == anprc-1) ) then
         write(*, "(28x, 'For Process ', I4.4, ', ChemP_BT, nT_BT = ', sp, es19.12, ss, es20.12)") amyid, ChemP_BT, nT_BT
      end if
         call MPI_Barrier(acomm, ierr)
#else
         write(*, "(28x, 'For Process ', I4.4, ', ChemP_BT, nT_BT = ', sp, es19.12, ss, es20.12)") amyid, ChemP_BT, nT_BT
#endif
      end if
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for starting part process _________________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
      call system_clock(time2)
      TimeSgBIN = TimeIntrvl(time1, time2)
!**************************************************************************************************	  
!___________________ 3. Output consumed time of this starting part of CPMC ________________________
!**************************************************************************************************
      call SaveCalTim(NB)
!v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%
!________________________ Call MPI_Barrier to make all the processes synchronous ______________________________
!v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%&v%      
#ifdef MPIPROCESS
      call MPI_Barrier(acomm, ierr)	
#endif
		
   end subroutine CPMCSmuBgn
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine InitUDVMatrx()
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  InitUDVMatrx()
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to initialize the ULeft, DLeftVec, VLeft and URght, DRghtVec, VRght matrices
!                  at the beginning of every sweep.
! KEYWORDS: Initialize the UDV matrices.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Initialize the UDV matricesat the beginning of every sweep simulation, For both IfSymTrot == F 
!                and IfSymTrot == T cases.
!
!     Input:  (none);  Output: (none)
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________ 
		use RealPrecsn
		use CoreParamt
		implicit none
!______________________________________________________________________________________________________________  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________      
      integer Iwalk, I1, I2, SpnInd
!______________________________________________________________________________________________________________	  
!___________________________ Main calculations of adjusting the constant ______________________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Initializations for both IfSymTrot == 0 and 1 cases _______________________
!**************************************************************************************************
!________________________________________________________________________________________ 	  
!_________________ (0) For URght, DRghtVec and VRght matrices ___________________________
!________________________________________________________________________________________          
      do Iwalk = 1, NWalk, +1
         call dcopy(NumNS*NumNS*2, IdMtR(1, 1, 1), 1, URght(1, 1, 1, Iwalk), 1)
         DRghtVec(1:NumNS, 1:NmSpn, Iwalk) = 1.0_rp
         call dcopy(NumNS*NumNS*2, IdMtR(1, 1, 1), 1, VRght(1, 1, 1, Iwalk), 1)
      enddo
      LogScaleRght = 0.0_rp
!________________________________________________________________________________________ 	  
!_________________ (1) For ULeft, DLeftVec and VLeft matrices ___________________________
!________________________________________________________________________________________
      do SpnInd = 1, NmSpn, +1
         do I2 = 1, NumNS, +1
            do I1 = 1, NumNS, +1
               VLeft(I1, I2, SpnInd) = HT_EigVect(I1, I2, SpnInd)
               ULeft(I1, I2, SpnInd) = HT_EigVect(I2, I1, SpnInd)
            enddo
            DLeftVec(I2, SpnInd) = exp( - BetaT*HT_EigValu(I2, SpnInd) - LogScaleOfHT(SpnInd, 0) )
         enddo
         LogScaleLeft(SpnInd) = LogScaleOfHT(SpnInd, 0)
      enddo
      
   end subroutine InitUDVMatrx
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$