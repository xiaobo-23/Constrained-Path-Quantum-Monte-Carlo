!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
! PROGRAM: A few subroutines used for calculating the multiplication of AMat matrix and the exponential HubbU matrix. 
!             Including 4 different
!                cases as: (1) AMat*exp(-\Delta\tau*H_U); (2) exp(-\Delta\tau*H_U)*AMat; 
!                          (3) AMat*[exp(-\Delta\tau*H_U)]^{-1};  (4) [exp(-\Delta\tau*H_U)]^{-1} * AMat;
!          Includes four different subroutines.
! COMMENT: Exponential HubbU matrix multiplying matrix AMat (at left and right side).
! AUTHOR:  Yuan-Yao He
! DATE:    2020-02-27
! PURPOSE: Different subroutines are introduced as following:
!
!     Calculate Exp(+/-\Delta\tau*H_U)*AMat and AMat*Exp(+/-\Delta\tau*H_U).
!
!   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!   These four subroutines are for exp(+/-\Delta\tau*H_U) 
!   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!   RghtMultExpbU    --> Calculate  exp(-\Delta\tau*H_U)      *AMat;
!   RghtMultExpbUInv --> Calculate [exp(-\Delta\tau*H_U)]^{-1}*AMat;
!   LeftMultExpbU    --> Calculate AMat* exp(-\Delta\tau*H_U)      ;
!   LeftMultExpbUInv --> Calculate AMat*[exp(-\Delta\tau*H_U)]^{-1}.
!
!   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!   These four subroutines are for exp[+/-\Delta\tau*(H_U+H_0-H_T)]
!   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!   RghtMultExpbU_H0T    --> Calculate  exp(-\Delta\tau*H_U)      *AMat;
!   RghtMultExpbUInv_H0T --> Calculate [exp(-\Delta\tau*H_U)]^{-1}*AMat;
!   LeftMultExpbU_H0T    --> Calculate AMat* exp(-\Delta\tau*H_U)      ;
!   LeftMultExpbUInv_H0T --> Calculate AMat*[exp(-\Delta\tau*H_U)]^{-1}.
!   
!          
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

   
   
!########################################################################################################################
!########################################################################################################################
!############################## Exp(+/-\Delta\tau*H_U)*AMat and AMat*Exp(+/-\Delta\tau*H_U) #############################
!############################## Exp(+/-\Delta\tau*H_U)*AMat and AMat*Exp(+/-\Delta\tau*H_U) #############################
!########################################################################################################################
!########################################################################################################################



!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine RghtMultExpbU(AuxiField, AMat, ND2) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  RghtMultExpbU(AuxiField, AMat, ND2)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as  Exp(-\Delta\tau*H_U)*AMat.
! KEYWORDS: Exp(-\Delta\tau*H_U)*AMat.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate Exp(-\Delta\tau*H_U)*AMat.
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            AMat      --> Input matrix;
!            ND2       --> Dimension of AMat;
! 
!     Outpt: AMat      --> Finally = exp(-\Delta\tau*H_U)*AMat
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)             ! Input auxiliary fields
      integer ND2
      real(rp) AMat(NumNS, NumNS, NmSpn)   ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                ! Starting time point
		integer(8) time2                ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!____________________________________ Calculate exp(-\Delta\tau*H_U)*AMat _____________________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product Exp(-\Delta\tau*H_U)*AMat ___________________________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, ND2, +1
         do SpnInd = 1, NmSpn, +1
            do I1 = 1, NumNS, +1
               AMat(I1, I2, SpnInd) = ExpobU(SpnInd, AuxiField(I1), I1) * AMat(I1, I2, SpnInd)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine RghtMultExpbU
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine RghtMultExpbUInv(AuxiField, AMat, ND2) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  RghtMultExpbUInv(AuxiField, AMat, ND2)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as [Exp(-\Delta\tau*H_U)]^{-1}*AMat.
! KEYWORDS: [Exp(-\Delta\tau*H_U)]^{-1}*AMat.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate [Exp(-\Delta\tau*H_U)]^{-1}.
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            AMat      --> Input matrix;
!            ND2       --> Dimension of AMat;
! 
!     Outpt: AMat      --> Finally = [Exp(-\Delta\tau*H_U)]^{-1}*AMat
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)            ! Input auxiliary fields
      integer ND2
      real(rp) AMat(NumNS, NumNS, NmSpn)  ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                    ! Starting time point
		integer(8) time2                    ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!_______________________________ Calculate [Exp(-\Delta\tau*H_U)]^{-1}*AMat ___________________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product [Exp(-\Delta\tau*H_U)]^{-1}*AMat ____________________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, ND2, +1
         do SpnInd = 1, NmSpn, +1
            do I1 = 1, NumNS, +1
               AMat(I1, I2, SpnInd) = ExpobUInv(SpnInd, AuxiField(I1), I1) * AMat(I1, I2, SpnInd)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine RghtMultExpbUInv
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$

   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine LeftMultExpbU(AuxiField, ND1, AMat) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  LeftMultExpbU(AuxiField, ND1, AMat)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as AMat*Exp(-\Delta\tau*H_U).
! KEYWORDS: AMat*Exp(-\Delta\tau*H_U).
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate AMat*Exp(-\Delta\tau*H_U).
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            ND1       --> Dimension of AMat;
!            AMat      --> Input matrix;
! 
!     Outpt: AMat      --> Finally = AMat*Exp(-\Delta\tau*H_U)
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)             ! Input auxiliary fields
      integer ND1
      real(rp) AMat(NumNS, NumNS, NmSpn)   ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                    ! Starting time point
		integer(8) time2                    ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!____________________________________ Calculate AMat*Exp(-\Delta\tau*H_U) _____________________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product AMat*Exp(-\Delta\tau*H_U) ___________________________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, NumNS, +1
         do SpnInd = 1, NmSpn, +1       
            do I1 = 1, ND1, +1
               AMat(I1, I2, SpnInd) = AMat(I1, I2, SpnInd) * ExpobU(SpnInd, AuxiField(I2), I2)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine LeftMultExpbU
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   


!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine LeftMultExpbUInv(AuxiField, ND1, AMat) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  LeftMultExpbUInv(AuxiField, ND1, AMat)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as AMat*[Exp(-\Delta\tau*H_U)]^{-1}.
! KEYWORDS: AMat*[Exp(-\Delta\tau*H_U)]^{-1}.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate AMat*[Exp(-\Delta\tau*H_U)]^{-1}.
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            AMat      --> Input matrix;
! 
!     Outpt: AMat      --> Finally = AMat*[Exp(-\Delta\tau*H_U)]^{-1}
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)             ! Input auxiliary fields
      integer ND1
      real(rp) AMat(NumNS, NumNS, NmSpn)   ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                    ! Starting time point
		integer(8) time2                    ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!_________________________________ Calculate AMat*[Exp(-\Delta\tau*H_U)]^{-1} ____________________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product AMat*[Exp(-\Delta\tau*H_U)]^{-1} ____________________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, NumNS, +1
         do SpnInd = 1, NmSpn, +1           
            do I1 = 1, ND1, +1
               AMat(I1, I2, SpnInd) = AMat(I1, I2, SpnInd) * ExpobUInv(SpnInd, AuxiField(I2), I2)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine LeftMultExpbUInv
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



!########################################################################################################################
!########################################################################################################################
!################## Exp[+/-\Delta\tau*(H_U+H_0-H_T)]*AMat and AMat*Exp[+/-\Delta\tau*(H_U+H_0-H_T)] #####################
!################## Exp[+/-\Delta\tau*(H_U+H_0-H_T)]*AMat and AMat*Exp[+/-\Delta\tau*(H_U+H_0-H_T)] #####################
!########################################################################################################################
!########################################################################################################################



!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine RghtMultExpbU_H0T(AuxiField, AMat, ND2) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  RghtMultExpbU_H0T(AuxiField, AMat, ND2)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as  Exp[-\Delta\tau*(H_U+H_0-H_T)]*AMat.
! KEYWORDS: Exp[-\Delta\tau*(H_U+H_0-H_T)]*AMat.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate Exp[-\Delta\tau*(H_U+H_0-H_T)]*AMat.
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            AMat      --> Input matrix;
!            ND2       --> Dimension of AMat;
! 
!     Outpt: AMat      --> Finally = Exp[-\Delta\tau*(H_U+H_0-H_T)]*AMat
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)             ! Input auxiliary fields
      integer ND2
      real(rp) AMat(NumNS, NumNS, NmSpn)   ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                ! Starting time point
		integer(8) time2                ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!____________________________________ Calculate Exp[-\Delta\tau*(H_U+H_0-H_T)]*AMat ___________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product Exp[-\Delta\tau*(H_U+H_0-H_T)]*AMat _________________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, ND2, +1
         do SpnInd = 1, NmSpn, +1
            do I1 = 1, NumNS, +1
               AMat(I1, I2, SpnInd) = ExpobU_H0T(SpnInd, AuxiField(I1), I1) * AMat(I1, I2, SpnInd)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine RghtMultExpbU_H0T
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$



   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine RghtMultExpbUInv_H0T(AuxiField, AMat, ND2) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  RghtMultExpbUInv_H0T(AuxiField, AMat, ND2)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as [Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}*AMat.
! KEYWORDS: [Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}*AMat.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate [Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}.
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            AMat      --> Input matrix;
!            ND2       --> Dimension of AMat;
! 
!     Outpt: AMat      --> Finally = [Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}*AMat
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)            ! Input auxiliary fields
      integer ND2
      real(rp) AMat(NumNS, NumNS, NmSpn)  ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                    ! Starting time point
		integer(8) time2                    ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!_______________________________ Calculate [Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}*AMat _________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product [Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}*AMat __________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, ND2, +1
         do SpnInd = 1, NmSpn, +1
            do I1 = 1, NumNS, +1
               AMat(I1, I2, SpnInd) = ExpobUInv_H0T(SpnInd, AuxiField(I1), I1) * AMat(I1, I2, SpnInd)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine RghtMultExpbUInv_H0T
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   
   

!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine LeftMultExpbU_H0T(AuxiField, ND1, AMat) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  LeftMultExpbU_H0T(AuxiField, ND1, AMat)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as AMat*Exp[-\Delta\tau*(H_U+H_0-H_T)].
! KEYWORDS: AMat*Exp[-\Delta\tau*(H_U+H_0-H_T)].
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate AMat*Exp[-\Delta\tau*(H_U+H_0-H_T)].
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            ND1       --> Dimension of AMat;
!            AMat      --> Input matrix;
! 
!     Outpt: AMat      --> Finally = AMat*Exp[-\Delta\tau*(H_U+H_0-H_T)]
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)             ! Input auxiliary fields
      integer ND1
      real(rp) AMat(NumNS, NumNS, NmSpn)   ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                    ! Starting time point
		integer(8) time2                    ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!____________________________________ Calculate AMat*Exp[-\Delta\tau*(H_U+H_0-H_T)] ___________________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product AMat*Exp[-\Delta\tau*(H_U+H_0-H_T)] _________________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, NumNS, +1
         do SpnInd = 1, NmSpn, +1       
            do I1 = 1, ND1, +1
               AMat(I1, I2, SpnInd) = AMat(I1, I2, SpnInd) * ExpobU_H0T(SpnInd, AuxiField(I2), I2)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine LeftMultExpbU_H0T
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
   

   
   
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
!____________________________________ Begin subroutine __________________________________________________________________
!________________________________________________________________________________________________________________________
	subroutine LeftMultExpbUInv_H0T(AuxiField, ND1, AMat) 
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     
! PROGRAM:  LeftMultExpbUInv_H0T(AuxiField, ND1, AMat)  
! TYPE:     subroutine
! PURPOSE:  This Subroutine is used to perform the calculations as AMat*[Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}.
! KEYWORDS: AMat*[Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}.
! AUTHOR:   Yuan-Yao He
! TIME:     2020-02-27
! DESCRIPTION: Calculate AMat*[Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}.
!
!     Input: AuxiField --> The auxiliary field AuxiField(NumNS);
!            AMat      --> Input matrix;
! 
!     Outpt: AMat      --> Finally = AMat*[Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1}
!
! END PROGRAM
!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   
!______________________________________________________________________________________________________________	  
!_________________________________________ Modules used in this subroutine ____________________________________
!______________________________________________________________________________________________________________
		use RealPrecsn
      use CoreParamt
		use TimeRecord
		use QMCTimeRec
		implicit none
!______________________________________________________________________________________________________________	  
!_________________________________________ All Input and Output Quantities ____________________________________
!______________________________________________________________________________________________________________
      integer AuxiField(NumNS)             ! Input auxiliary fields
      integer ND1
      real(rp) AMat(NumNS, NumNS, NmSpn)   ! Input/Output real matrix
!______________________________________________________________________________________________________________	  
!______________________________ Temperory Quantities used in the calculations _________________________________
!______________________________________________________________________________________________________________
      integer(8) time1                    ! Starting time point
		integer(8) time2                    ! Ending   time point
      integer I1, I2, SpnInd
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
		TimsbUPrp = TimsbUPrp + 1
		call system_clock(time1)
!______________________________________________________________________________________________________________	  
!_________________________________ Calculate AMat*[Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1} _______________________
!______________________________________________________________________________________________________________
!**************************************************************************************************	  
!___________________ 0. Calculate the product AMat*[Exp[-\Delta\tau*(H_U+H_0-H_T)]]^{-1} __________
!**************************************************************************************************
   !$OMP PARALLEL &
   !$OMP PRIVATE(I2, SpnInd, I1)
   !$OMP DO
      do I2 = 1, NumNS, +1
         do SpnInd = 1, NmSpn, +1           
            do I1 = 1, ND1, +1
               AMat(I1, I2, SpnInd) = AMat(I1, I2, SpnInd) * ExpobUInv_H0T(SpnInd, AuxiField(I2), I2)
            enddo
         enddo
      enddo
   !$OMP END DO
   !$OMP END PARALLEL
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&  
!_________________ Counting calling times and time consumed for H_U propagation process _______________________
!%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&%&
      call system_clock(time2)
		TimebUPrp = TimebUPrp + TimeIntrvl(time1, time2)
		
   end subroutine LeftMultExpbUInv_H0T
!________________________________________________________________________________________________________________________  
!____________________________________ End subroutine ____________________________________________________________________
!$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$